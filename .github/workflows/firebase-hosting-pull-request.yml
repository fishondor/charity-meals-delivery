# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Test on PR
'on': pull_request
jobs:
  set_environment:
    runs-on: ubuntu-latest
    environment: QA
    steps:
      - uses: actions/checkout@v2
      - name: Make envfile
        uses: SpicyPizza/create-envfile@v1
        with:
          envkey_VUE_APP_FIREBASE_API_KEY: ${{ secrets.VUE_APP_FIREBASE_API_KEY }}
          envkey_VUE_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.VUE_APP_FIREBASE_AUTH_DOMAIN }}
          envkey_VUE_APP_FIREBASE_DATABASE_URL: ${{ secrets.VUE_APP_FIREBASE_DATABASE_URL }}
          envkey_VUE_APP_FIREBASE_PROJECT_ID: ${{ secrets.VUE_APP_FIREBASE_PROJECT_ID }}
          envkey_VUE_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.VUE_APP_FIREBASE_STORAGE_BUCKET }}
          file_name: client/.env.local
      - uses: actions/upload-artifact@master
        with:
          name: env-file
          path: client/.env.local
  cypress-run:
    needs: set_environment
    defaults:
      run:
        working-directory: client
    runs-on: ubuntu-latest
    environment: QA
    container: cypress/browsers:node12.18.3-chrome87-ff82
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Decrypt cypress env
        run: ../.github/scripts/decrypt_secret.sh
        env:
          GPG_PASS: ${{ secrets.GPG_PASS }}

      # Install NPM dependencies, cache them correctly
      # and run all Cypress tests
      - run: npm install
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          # Specify Browser since container image is compile with Firefox
          working-directory: client
          start: npm run serve
          wait-on: http://localhost:4200/
          config-file: cypress.json
          spec: "cypress/integration/admin/**/*"
          browser: chrome
